name: Release

on:
  push:
    branches:
      - "fix/debug-package-signing-issue"

jobs:
  create_apt_repo:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source code
        uses: actions/checkout@v2

      - name: Setup dpkg-dev
        run: sudo apt-get install -y dpkg-dev gnupg2 devscripts debsigs apt-utils

      - name: Setup GPG
        env:
          PRIVATE_GPG_KEY: ${{ secrets.PRIVATE_GPG_KEY }}
          PUBLIC_GPG_KEY: ${{ secrets.PUBLIC_GPG_KEY }}
        run: |
          echo "$PRIVATE_GPG_KEY" | gpg --import
          echo "$PUBLIC_GPG_KEY" | gpg --import

      - name: Build package
        run: |
          export TAG="${{ github.ref }}"
          export VERSION=$(echo "${TAG}" | sed 's/^refs\/tags\/v//')
          mkdir please
          cd please
          mkdir -p usr/local/bin
          mkdir DEBIAN
          mv ../please.sh usr/local/bin/please
          echo "Package: please
          Version: ${VERSION}
          Section: base
          Priority: optional
          Architecture: all
          Maintainer: TNG Technology Consulting GmbH <info@tngtech.com>
          Depends: curl, jq, libsecret-tools, xclip
          Description: An AI helper script to create CLI commands" > DEBIAN/control
          cd ..
          dpkg-deb --build please
          debsigs --sign=origin please.deb


